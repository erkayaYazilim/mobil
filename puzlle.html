<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Puzzle Görsel Yükleme</title>
  <!-- Firebase SDK’ları (v8 compat) -->
 <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 50px;
    }
    h1, h2 {
      margin-bottom: 20px;
      color: #333;
    }
    nav a {
      margin-right: 12px;
      text-decoration: none;
      color: #1976D2;
    }
    nav a:hover {
      text-decoration: underline;
    }
    #uploadForm {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 320px;
    }
    #fileInput {
      margin-bottom: 15px;
    }
    #uploadBtn {
      padding: 10px 20px;
      border: none;
      background: #1976D2;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    #uploadBtn:disabled {
      background: #90CAF9;
      cursor: default;
    }
    #status {
      margin-top: 15px;
      font-size: 14px;
      color: #555;
      min-height: 18px;
    }
    #list {
      margin-top: 30px;
      width: 90%;
      max-width: 600px;
    }
    .card {
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      padding: 10px;
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }
    .card img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 4px;
      margin-right: 12px;
    }
    .card button {
      margin-left: auto;
      padding: 6px 12px;
      border: none;
      background: #F44336;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Puzzle Görsel Yükle</h1>
  <nav>
    <a href="main.html">Ana Sayfa</a>
    <a href="question.html">Soru Yükle</a>
    <a href="approve.html">Blog Onay Paneli</a>
    <a href="upload.html">Blog Yükle</a>
    <a href="editQuestions.html">Soru Düzenle</a>
    <a href="blockedUsers.html">Engellenenler</a>
    <a href="odulYukle.html">Ödül Yükle</a>
    <a href="odulDuzenle.html">Ödülleri Düzenle</a>
    <a href="odulAlanlar.html">Ödül Alanlar</a>
    <a href="#" onclick="showNotificationForm()">Bildirim Gönder</a>
    <a href="yastahmin.html">Yaş Oyunu</a>
    <a href="transfertahmin.html">Transfer Oyunu</a>
    <a href="puzlle.html">Puzzle Oyunu</a>
    <a href="futbolcubil.html">Futbolcu Bil</a>
    <a href="#" onclick="logout()">Çıkış Yap</a>
  </nav>

  <div id="uploadForm">
    <input type="file" id="fileInput" accept="image/*">
    <button id="uploadBtn" disabled>Yükle</button>
    <p id="status"></p>
  </div>

  <h2>Yüklenen Puzzle Görselleri</h2>
  <div id="list"></div>

  <script>
    // 1) Firebase yapılandırma
    const firebaseConfig = {
      apiKey: "AIzaSyDbxMYDAd2AI1riU9kcPG6K2LT_lB1TR8s",
      authDomain: "futbolmobil-7be36.firebaseapp.com",
      databaseURL: "https://futbolmobil-7be36-default-rtdb.firebaseio.com",
      projectId: "futbolmobil-7be36",
      storageBucket: "futbolmobil-7be36.firebasestorage.app",
      messagingSenderId: "311578958726",
      appId: "1:311578958726:web:486cb815a7674702af2a07",
      measurementId: "G-NE0LTTF1EP"
    };
    firebase.initializeApp(firebaseConfig);

    // 2) Referanslar
    var storageRef = firebase.storage().ref();
    var dbRef      = firebase.database().ref('puzzleImages');

    var fileInput   = document.getElementById('fileInput');
    var uploadBtn   = document.getElementById('uploadBtn');
    var statusText  = document.getElementById('status');
    var listEl      = document.getElementById('list');
    var selectedFile = null;

    // 3) Dosya seçildiğinde butonu aktif et
    fileInput.addEventListener('change', function(e) {
      if (e.target.files.length > 0) {
        selectedFile = e.target.files[0];
        uploadBtn.disabled = false;
        statusText.textContent = '';
      }
    });

    // 4) Görseli sıkıştıran yardımcı fonksiyon
    function compressImage(file) {
      return new Promise(function(resolve, reject) {
        var img = new Image();
        img.onload = function() {
          var canvas = document.createElement('canvas');
          canvas.width  = img.width;
          canvas.height = img.height;
          var ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          canvas.toBlob(function(blob) {
            if (blob) resolve(blob);
            else reject(new Error('Blob oluşmadı'));
          }, 'image/jpeg', 0.2); // kalite %20
        };
        img.onerror = function(e) {
          reject(e);
        };
        img.src = URL.createObjectURL(file);
      });
    }

    // 5) Yükleme işlemi
    uploadBtn.addEventListener('click', function() {
      if (!selectedFile) return;

      uploadBtn.disabled = true;
      statusText.textContent = 'Yükleniyor…';

      var filename = 'puzzle_' + Date.now() + '_' + selectedFile.name;
      var fileRef  = storageRef.child('puzzles/' + filename);

      compressImage(selectedFile)
        .then(function(compressedBlob) {
          return fileRef.put(compressedBlob);
        })
        .then(function(snapshot) {
          return snapshot.ref.getDownloadURL();
        })
        .then(function(downloadURL) {
          return dbRef.push({ url: downloadURL, uploadedAt: Date.now() });
        })
        .then(function() {
          statusText.textContent = 'Başarıyla yüklendi!';
          fileInput.value    = '';
          selectedFile       = null;
        })
        .catch(function(err) {
          console.error(err);
          statusText.textContent = 'Hata: ' + err.message;
        })
        .finally(function() {
          uploadBtn.disabled = true;
        });
    });

    // 6) Mevcut kayıtları listele & sil
    dbRef.on('value', function(snapshot) {
      listEl.innerHTML = '';
      snapshot.forEach(function(child) {
        var data = child.val();
        var key  = child.key;

        var card = document.createElement('div');
        card.className = 'card';

        var img = document.createElement('img');
        img.src = data.url;
        img.alt = 'Puzzle';

        var btn = document.createElement('button');
        btn.textContent = 'Sil';
        btn.onclick = function() {
          if (!confirm('Bu görseli silmek istediğinize emin misiniz?')) return;

          // Storage’dan da sil
          firebase.storage().refFromURL(data.url).delete()
            .catch(function(err) {
              console.warn('Storage silme hatası:', err);
            });

          // Database kaydını sil
          dbRef.child(key).remove();
        };

        card.appendChild(img);
        card.appendChild(btn);
        listEl.appendChild(card);
      });
    });
  </script>
</body>
</html>
