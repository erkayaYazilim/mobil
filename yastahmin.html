<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Yaş Oyunu – Admin</title>
  <style>
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial, sans-serif;background:#f4f4f4;color:#333;line-height:1.6;padding:15px}
    header{background:#008577;color:#fff;padding:15px;text-align:center}
    nav{background:#eee;padding:10px;display:flex;flex-wrap:wrap;justify-content:center;gap:8px}
    nav a{padding:8px 12px;text-decoration:none;border-radius:4px;background:#ccc;color:#000;font-weight:bold}
    nav a:hover{background:#bbb}
    .container{max-width:600px;width:95%;background:#fff;margin:20px auto;padding:20px;border-radius:5px;box-shadow:0 2px 5px rgba(0,0,0,.2)}
    h2{margin-bottom:14px}
    label{display:block;margin:10px 0 6px;color:#555}
    input[type="text"],input[type="number"],textarea{width:100%;padding:10px;font-size:16px;border:1px solid #ccc;border-radius:3px}
    input[type="file"]{margin:10px 0}
    button{padding:12px;margin-top:16px;background:#28a745;color:#fff;border:none;border-radius:3px;font-size:16px;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .status{margin-top:12px;text-align:center;color:#333;min-height:20px}
    .preview{margin-top:10px;text-align:center}
    .preview img{max-width:100%;border-radius:5px}
    @media (max-width:600px){input,textarea{font-size:14px}button{font-size:14px;padding:10px}}
  </style>

  <!-- Firebase v8 (ödül sayfası ile aynı mantık) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <!-- App Check enforced ise AÇ (site key’ini yaz) -->
  <!-- <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app-check.js"></script> -->
</head>
<body>
  <header><h1>Yaş Oyunu – Admin</h1></header>

  <nav>
    <a href="main.html">Ana Sayfa</a>
    <a href="question.html">Soru Yükle</a>
    <a href="approve.html">Blog Onay Paneli</a>
    <a href="upload.html">Blog Yükle</a>
    <a href="editQuestions.html">Soru Düzenle</a>
    <a href="blockedUsers.html">Engellenenler</a>
    <a href="odulYukle.html">Ödül Yükle</a>
    <a href="odulDuzenle.html">Ödülleri Düzenle</a>
    <a href="odulAlanlar.html">Ödül Alanlar</a>
    <a href="yastahmin.html">Yaş Oyunu</a>
    <a href="transfertahmin.html">Transfer Oyunu</a>
    <a href="puzlle.html">Puzzle Oyunu</a>
    <a href="futbolcubil.html">Futbolcu Bil</a>
  </nav>

  <div class="container">
    <h2>Oyuncu Ekle</h2>
    <form id="playerForm">
      <label for="photo">Fotoğraf:</label>
      <input type="file" id="photo" accept="image/*" required>
      <div id="preview" class="preview"></div>

      <label for="name">Ad Soyad:</label>
      <input type="text" id="name" placeholder="Futbolcu Adı" required>

      <label for="year">Doğum Yılı:</label>
      <input type="number" id="year" placeholder="YYYY" min="1900" max="2025" required>

      <button type="submit" id="submitBtn" disabled>Kaydet</button>
    </form>
    <div id="status" class="status"></div>
  </div>

  <script>
    // --- Firebase config (appspot.com dikkat!) ---
    const firebaseConfig = {
      apiKey: "AIzaSyDbxMYDAd2AI1riU9kcPG6K2LT_lB1TR8s",
      authDomain: "futbolmobil-7be36.firebaseapp.com",
      databaseURL: "https://futbolmobil-7be36-default-rtdb.firebaseio.com",
      projectId: "futbolmobil-7be36",
      storageBucket: "futbolmobil-7be36.appspot.com",
      messagingSenderId: "311578958726",
      appId: "1:311578958726:web:486cb815a7674702af2a07",
      measurementId: "G-NE0LTTF1EP"
    };
    firebase.initializeApp(firebaseConfig);

    // App Check ENFORCED ise aktif et:
    // const appCheck = firebase.appCheck();
    // appCheck.activate('RECAPTCHA_V3_SITE_KEY', true);

    const auth = firebase.auth();
    const storage = firebase.storage();
    const db = firebase.database();

    // --- Giriş yoksa ödül sayfasındaki gibi yönlendir ---
    auth.onAuthStateChanged(user => {
      if (!user) {
        // e-posta/şifre ile giriş gerektir
        window.location.href = "index.html";
      } else {
        document.getElementById('submitBtn').disabled = false;
      }
    });

    // --- Önizleme ---
    const photoInput = document.getElementById('photo');
    const previewDiv = document.getElementById('preview');
    photoInput.addEventListener('change', function () {
      const f = this.files[0];
      if (!f) return (previewDiv.innerHTML = '');
      const reader = new FileReader();
      reader.onload = e => previewDiv.innerHTML = `<img src="${e.target.result}" alt="Önizleme">`;
      reader.readAsDataURL(f);
    });

    // --- Görsel sıkıştır (JPEG 0.7, genişlik 600 px) ---
    function compressImage(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = ev => {
          const img = new Image();
          img.src = ev.target.result;
          img.onload = () => {
            const MAX_W = 600;
            let { width: w, height: h } = img;
            if (w > MAX_W) { h = Math.round(h * (MAX_W / w)); w = MAX_W; }
            const canvas = document.createElement('canvas');
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            canvas.toBlob(b => {
              if (!b) return reject(new Error('Blob oluşmadı'));
              resolve(b);
            }, 'image/jpeg', 0.7);
          };
          img.onerror = reject;
        };
        reader.onerror = reject;
      });
    }

    // --- Dosya adı normalize (Türkçe karakterleri sadeleştir) ---
    function safeName(originalName) {
      const base = (originalName || 'foto')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'') // aksanlar
        .replace(/\s+/g,'_');                            // boşluklar
      return base.replace(/[^\w.\-]/g, '');              // güvenli karakter seti
    }

    // --- Form gönderimi (ödül mantığıyla aynı akış) ---
    const form = document.getElementById('playerForm');
    const statusEl = document.getElementById('status');
    const submitBtn = document.getElementById('submitBtn');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      submitBtn.disabled = true;
      statusEl.textContent = 'Yükleniyor...';

      try {
        const file = photoInput.files[0];
        const name = document.getElementById('name').value.trim();
        const year = parseInt(document.getElementById('year').value, 10);

        if (!file || !name || !year) {
          throw new Error('Lütfen tüm alanları doldurun.');
        }
        if (!auth.currentUser) {
          throw new Error('Oturum yok (giriş yapın).');
        }

        const blob = await compressImage(file);
        const norm = safeName(file.name).replace(/\.[^.]+$/, '') + '.jpg';
        const path = 'players/' + Date.now() + '_' + norm;

        const fileRef = storage.ref().child(path);
        const snap = await fileRef.put(blob, { contentType: 'image/jpeg' });
        const downloadURL = await snap.ref.getDownloadURL();

        const rec = {
          name: name,
          year: year,
          photoUrl: downloadURL,
          path: path,
          createdAt: Date.now(),
          by: auth.currentUser.uid
        };
        await db.ref('players').push(rec);

        statusEl.textContent = 'Oyuncu başarıyla eklendi!';
        form.reset();
        previewDiv.innerHTML = '';
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Hata: ' + (err.message || err.code);
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
