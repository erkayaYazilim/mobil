<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel - Futbolcu Yönetimi</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; margin:0; padding:20px; }
    .container { max-width: 700px; margin:auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.08); }
    h1 { text-align:center; margin:0 0 12px; }
    nav { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px; }
    nav a { font-size:14px; color:#6200EE; text-decoration:none; }
    nav a:hover { text-decoration:underline; }
    form { display:flex; flex-direction:column; gap:10px; margin-bottom:20px; }
    input[type="text"], input[type="number"], input[type="email"], input[type="password"], input[type="file"] { padding:8px; border:1px solid #ccc; border-radius:4px; }
    button { padding:10px; border:none; border-radius:4px; cursor:pointer; }
    .primary { background:#28a745; color:#fff; }
    .primary:disabled { background:#94d3a2; cursor:not-allowed; }
    .danger { background:#dc3545; color:#fff; }
    .status { text-align:center; margin-top:8px; color:#333; min-height: 20px; }
    .player-list { display:flex; flex-direction:column; gap:10px; }
    .player-item { display:flex; align-items:center; gap:10px; padding:10px; background:#fafafa; border:1px solid #ddd; border-radius:6px; }
    .player-item img { width:60px; height:60px; object-fit:cover; border-radius:50%; }
    .row { display:flex; gap:8px; align-items:center; }
    .muted { color:#666; font-size:13px; }
    .hidden { display:none; }
  </style>

  <!-- Firebase compat SDK'lar -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <!-- App Check gerekiyorsa aç -->
  <!-- <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script> -->
</head>
<body>
  <div class="container">
    <h1>Futbolcu Yönetim Paneli</h1>

    <nav>
      <a href="main.html">Ana Sayfa</a>
      <a href="question.html">Soru Yükle</a>
      <a href="approve.html">Onay Paneli</a>
      <a href="upload.html">Blog Yükle</a>
      <a href="editQuestions.html">Soru Düzenle</a>
      <a href="blockedUsers.html">Engellenenler</a>
      <a href="yastahmin.html">Yaş Oyunu</a>
      <a href="transfertahmin.html">Transfer Oyunu</a>
      <a href="puzlle.html">Puzzle Oyunu</a>
      <a href="futbolcubil.html">Futbolcu Bil</a>
    </nav>

    <!-- GİRİŞ BLOĞU -->
    <div id="authBox">
      <h3>Giriş yap</h3>
      <form id="loginForm">
        <input type="email" id="email" placeholder="E-posta" required />
        <input type="password" id="password" placeholder="Şifre" required />
        <button type="submit" class="primary">Giriş Yap</button>
      </form>
      <div class="muted">Bu sayfayı görmek için e-posta/şifre ile oturum gerekli.</div>
    </div>

    <!-- UYGULAMA BLOĞU (yalnızca oturum varken görünür) -->
    <div id="appBox" class="hidden">
      <div class="row" style="justify-content: space-between;">
        <div class="muted" id="whoami"></div>
        <button id="logoutBtn" class="danger">Çıkış Yap</button>
      </div>

      <form id="playerForm">
        <label>Fotoğraf:<input type="file" id="photo" accept="image/*" required></label>
        <label>Ad Soyad:<input type="text" id="name" placeholder="Futbolcu Adı" required></label>
        <label>Doğum Yılı:<input type="number" id="year" placeholder="YYYY" min="1900" max="2025" required></label>
        <button type="submit" id="submitBtn" class="primary" disabled>Ekle</button>
      </form>

      <div class="status" id="status"></div>
      <div class="player-list" id="playerList"></div>
    </div>
  </div>

  <script>
    // ---------- Firebase init ----------
    const firebaseConfig = {
      apiKey: "AIzaSyDbxMYDAd2AI1riU9kcPG6K2LT_lB1TR8s",
      authDomain: "futbolmobil-7be36.firebaseapp.com",
      databaseURL: "https://futbolmobil-7be36-default-rtdb.firebaseio.com",
      projectId: "futbolmobil-7be36",
      storageBucket: "futbolmobil-7be36.appspot.com",
      messagingSenderId: "311578958726",
      appId: "1:311578958726:web:486cb815a7674702af2a07",
      measurementId: "G-NE0LTTF1EP"
    };
    firebase.initializeApp(firebaseConfig);

    // App Check ENFORCED ise şunu AÇ (reCAPTCHA v3 site key'ini yaz):
    // firebase.appCheck().activate('RECAPTCHA_V3_SITE_KEY', true);

    const auth = firebase.auth();
    const storage = firebase.storage();
    const database = firebase.database();

    // ---------- UI elemanları ----------
    const authBox   = document.getElementById('authBox');
    const appBox    = document.getElementById('appBox');
    const loginForm = document.getElementById('loginForm');
    const emailEl   = document.getElementById('email');
    const passEl    = document.getElementById('password');
    const whoamiEl  = document.getElementById('whoami');
    const logoutBtn = document.getElementById('logoutBtn');

    const form       = document.getElementById('playerForm');
    const statusEl   = document.getElementById('status');
    const playerList = document.getElementById('playerList');
    const submitBtn  = document.getElementById('submitBtn');

    // ---------- Auth davranışı ----------
    auth.onAuthStateChanged(user => {
      if (user) {
        // Giriş var → app aç
        authBox.classList.add('hidden');
        appBox.classList.remove('hidden');
        whoamiEl.textContent = `Giriş: ${user.email || user.uid}`;
        submitBtn.disabled = false;
        loadPlayers();
      } else {
        // Giriş yok → login göster
        appBox.classList.add('hidden');
        authBox.classList.remove('hidden');
      }
    });

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        await auth.signInWithEmailAndPassword(emailEl.value, passEl.value);
      } catch (err) {
        alert('Giriş hatası: ' + (err.message || err.code));
      }
    });

    logoutBtn.addEventListener('click', () =>
      auth.signOut().catch(e => alert('Çıkış hatası: ' + (e.message || e.code)))
    );

    // ---------- Görseli sıkıştır (jpeg, kalite %10) ----------
    function compressImage(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width  = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          canvas.toBlob(blob => {
            if (blob) {
              const out = new File([blob], file.name.replace(/\.[^.]+$/, '.jpg'), { type: 'image/jpeg' });
              resolve(out);
            } else reject(new Error('Blob oluşmadı'));
          }, 'image/jpeg', 0.1);
        };
        img.onerror = e => reject(e);
        img.src = URL.createObjectURL(file);
      });
    }

    // ---------- Upload + RTDB kayıt ----------
    form.addEventListener('submit', async e => {
      e.preventDefault();
      submitBtn.disabled = true;
      statusEl.textContent = 'Yükleniyor...';

      const file = document.getElementById('photo').files[0];
      const name = document.getElementById('name').value.trim();
      const year = document.getElementById('year').value;

      try {
        if (!file) throw new Error('Dosya seçilmedi');

        // Türkçe karakterleri sadeleştir (opsiyonel ama faydalı)
        const safeName = (file.name || 'foto').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'_');

        const imgFile    = await compressImage(file);
        const path       = 'players/' + Date.now() + '_' + safeName.replace(/\.[^.]+$/, '.jpg');
        const storageRef = storage.ref(path);

        const snap = await storageRef.put(imgFile, { contentType: imgFile.type });
        const photoURL = await snap.ref.getDownloadURL();

        const newRef = database.ref('players').push();
        await newRef.set({ name, year, photoUrl: photoURL, path, createdAt: Date.now() });

        statusEl.textContent = 'Oyuncu başarıyla eklendi.';
        form.reset();
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Hata: ' + (err.message || err.code);
      } finally {
        submitBtn.disabled = false;
      }
    });

    // ---------- Listele + Sil ----------
    function loadPlayers() {
      database.ref('players').on('value', snapshot => {
        playerList.innerHTML = '';
        snapshot.forEach(child => {
          const data = child.val();
          const key  = child.key;

          const item = document.createElement('div');
          item.className = 'player-item';

          const img = document.createElement('img');
          img.src = data.photoUrl;

          const info = document.createElement('div');
          info.className = 'player-info';
          info.innerHTML = `<strong>${data.name}</strong><br><span class="muted">Doğum Yılı: ${data.year}</span>`;

          const delBtn = document.createElement('button');
          delBtn.className = 'danger';
          delBtn.textContent = 'Sil';
          delBtn.onclick = async () => {
            if (!confirm('Silinsin mi?')) return;
            try {
              await database.ref('players/' + key).remove();
              if (data.path) {
                await storage.ref(data.path).delete();
              } else if (data.photoUrl) {
                await storage.refFromURL(data.photoUrl).delete();
              }
            } catch (e) {
              alert('Silme hatası: ' + (e.message || e.code));
            }
          };

          item.appendChild(img);
          item.appendChild(info);
          item.appendChild(delBtn);
          playerList.appendChild(item);
        });
      });
    }
  </script>
</body>
</html>
